#!/usr/bin/env bash

# Open directory in [v]im (neovim, else vi(m))
function v() {
	if command -v nvim >/dev/null 2>&1; then
		nvim "$1" 
	else
		vi "$1" 
	fi

}

# [s]earch [f]iles (text-readable, unhidden) with fzf fuzzy finding, open in (neo)vim
# sf -a includes all hidden files that aren't .git
function sf() {
	local dir=""
	# Find all "regular" files with rg, and open list in fzf
	if [[ -n "$1" && $1 == "-a" ]]; then
		dir=$(rg -L --files-with-matches --no-messages --hidden --glob '!.git' --max-depth 5 . | fzf --query "$2")
		# sf -a includes all hidden files that aren't .git
	else 
		dir=$(rg -L --files-with-matches --no-messages --max-depth 5 . | fzf --query "$1")
		# hidden files excluded by default
	fi
	# Runs if result non-empty and regular file
	if [[ -n "$dir" && -f "$dir" ]]; then
		v "$dir" # Makes use of v()
	fi
}

# [s]earch [d]irectory with fzf fuzzy finding, cd there
function sd() {
	local dir=$(find -L . -type d \( ! -path '*.git*' \) -mindepth 1 -maxdepth 4 | fzf --query "$1")
    [[ -n "$dir" && -d "$dir" ]] && builtin cd "$dir"
}

function cd() {
	if [[ $# -gt 0 && $1 == -* ]]; then
		builtin cd "$@"
		return
	fi

	if declare -F __zoxide_z >/dev/null 2>&1; then
		__zoxide_z "$@"
	else
		builtin cd "$@"
	fi
}


# Update environment variables in tmux (used in .bash_profile)
function update_environment_from_tmux() {
  if [ -n "${TMUX}" ]; then
    eval "$(tmux show-environment -s)"
  fi
}

# Create a new directory and enter it
function mkd() {
	mkdir -p "$@" && cd "$_";
}

# Determine size of a file or total size of a directory
function fs() {
	if du -b /dev/null > /dev/null 2>&1; then
		local arg=-sbh;
	else
		local arg=-sh;
	fi
	if [[ -n "$@" ]]; then
		du $arg -- "$@";
	else
		du $arg .[^.]* ./*;
	fi;
}

# Use Gitâ€™s colored diff when available
hash git &>/dev/null;
if [ $? -eq 0 ]; then
	function diff() {
		git diff --no-index --color-words "$@";
	}
fi;

# `o` with no arguments opens the current directory (I use this all the time)
function o() {
	if [ $# -eq 0 ]; then
		open .;
	else
		open "$@";
	fi;
}

# `tre` is a shorthand for `tree` with hidden files and color enabled, ignoring
# the `.git` directory, listing directories first. The output gets piped into
# `less` with options to preserve color and line numbers, unless the output is
# small enough for one screen.
function tre() {
	tree -aC -I '.git|node_modules|bower_components' --dirsfirst "$@" | less -FRNX;
}

# Write an LLM query in a visual editor, then send it to llm and pipe through richify.py
function llmq() {
	local editor prompt_file prompt
	editor=${VISUAL:-${VISUALEDITOR:-${EDITOR:-vi}}}
	prompt_file=$(mktemp "/tmp/llmq.XXXXXX") || return 1

	"$editor" "$prompt_file"

	prompt="$(cat "$prompt_file")"
	rm -f "$prompt_file"

	if [[ -z "${prompt//[[:space:]]/}" ]]; then
		echo "llmq: prompt empty, aborting." >&2
		return 1
	fi

	llm --model gpt-5-nano -s "Clear, Concise, Correct. User is smart, technical, knows you're an LLM. Give extremely concise, short, fast answer. Maximally helpful in the shortest time and length. Assume CLI, macOS, homebrew, Python (via uv), bash. Reply in Markdown and code snippets." "$prompt" | batmd
}
