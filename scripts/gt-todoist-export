#!/usr/bin/env bash

# Convert Todoist CSV exports to Markdown bullets with 4-space indentation
# Usage: ./<script_name> input.csv > output.md

set -euo pipefail

# Check if file argument is provided
if [ $# -ne 1 ]; then
    echo "Usage: $0 <todoist_export.csv>"
    exit 1
fi

input_file="$1"

# Check if file exists
if [ ! -f "$input_file" ]; then
    echo "Error: File '$input_file' not found."
    exit 1
fi

# Process the CSV file using Python's csv module (no need for gawk)
python3 << 'EOF'
import sys, csv

if len(sys.argv) != 2:
    sys.exit("Usage: {} <todoist_export.csv>".format(sys.argv[0]))

with open(sys.argv[1], newline='', encoding="utf-8") as csvfile:
    reader = csv.reader(csvfile)
    # Skip header row
    next(reader, None)

    for row in reader:
        # Skip meta rows and incomplete rows
        if not row or (row[0] == "meta"):
            continue
        # Ensure we have at least two columns
        if len(row) < 2:
            continue

        content = row[1].strip('"')
        description = (row[2].strip('"') if len(row) > 2 else "")

        if content:
            print("- " + content)
            if description:
                # Split description on literal "\n" characters
                for line in description.split("\\n"):
                    print("    - " + line)
EOF "$input_file"
