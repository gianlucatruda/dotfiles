#!/usr/bin/env bash

# Convert Todoist CSV exports to Markdown bullets with 4-space indentation
# Usage: ./<script_name> input.csv > output.md

set -euo pipefail

# Check if file argument is provided
if [ $# -ne 1 ]; then
    echo "Usage: $0 <todoist_export.csv>"
    exit 1
fi

input_file="$1"

# Check if file exists
if [ ! -f "$input_file" ]; then
    echo "Error: File '$input_file' not found."
    exit 1
fi

# Process the CSV file
gawk 'BEGIN { FPAT = "([^,]+)|(\"[^\"]+\")" }

# Skip header row, meta rows, and empty rows
NR > 1 && $1 != "meta" && NF > 1 {
    content = $2
    description = $3
    
    gsub(/^"|"$/, "", content)
    gsub(/^"|"$/, "", description)
    
    # Print as markdown bullet
    if (content != "") {
        print "- " content
        
        # Process description if it exists
        if (description != "") {
            # Split description into lines
            split(description, desc_lines, "\\n")
            for (line in desc_lines) {
                print "    - " desc_lines[line]
            }
        }
    }
}' "$input_file"
